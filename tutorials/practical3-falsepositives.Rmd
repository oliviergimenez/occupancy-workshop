---
title: "Practical 3: Dealing with false positives"
author: "Olivier Gimenez"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_depth: 2
date: "May 2023"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      dpi = 300, 
                      fig.height = 6, 
                      fig.width = 1.777777*6)
```

# Objectives

Reproduce analyses in *Determining Occurrence Dynamics when False Positives Occur: Estimating the Range Dynamics of Wolves from Public Survey Data* by Miller et al. in Plos One. 

https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0065808

Includes 2 data types - data from hunters who report whether they observed wolves while hunting for deer or elk. Other data comes from observations made by state agency personnel based on collaring and relocation by radio telemetry. Covariates include the amount of hunter effort, habitat quality, and whether observations were by hunters or agency personnel. Static analysis only uses data from the final year - 2010

Thanks David Miller. 

```{r}
library(unmarked)
```

# Data

Cells were divided based on perceived habitat quality into low, medium, and high quality categories (A). Most certain observations of known packs made by state agency personnel and based on collaring and relocation by radio telemetry were concentrated in the western end of the study area where the higher quality habitat was located (B). While high frequency of observations by hunters also occurred in high-quality areas, they also reported a low frequency of wolf observations in the eastern portion of the study area, which we suspected were due to misidentification (C).

```{r echo=FALSE, fig.width=5, fig.height=15, fig.align='center'}
knitr::include_graphics("images/dataFP.png")
```
Read in data
```{r}
wolves <- read.csv("data/MTwolves.csv")
```

Inspect data
```{r}
str(wolves)
```

Short description to be done.

# Modelling

## Start with only hunter reporting data for wolves and no accounting for false positives

```{r}
oc <- list(effort = wolves[,47:51])
```


```{r}
umf <- unmarkedFrameOccu(y = wolves[,20:24], obsCovs = oc)
```

Summarize data frame
```{r}
str(umf)
```

Fit model
```{r}
fm1 <- occu(~effort ~ 1, data = umf)
```

Estimates?
```{r}
coef(fm1)
```

Get occupancy prob estimate:

```{r}
1/(1 + exp(-coef(fm1)[1]))
```

Or 

```{r}
plogis(coef(fm1)[1])
```


Or
```{r}
backTransform(fm1, 'state')
```

Detection hunter as a function of effort:

```{r}
effort_grid <- seq(min(oc$effort), max(oc$effort), length = 100)
```

```{r}
logitp <- coef(fm1)[2] + coef(fm1)[3] * effort_grid
p <- plogis(logitp)
```

Compare figure below with Figure 3.
```{r}
plot(effort_grid, 
     p, 
     type = "l", 
     lwd = 3, 
     xlab = "effort", 
     ylab = "detection probability",
     ylim = c(0,1))
```

## Still only data for hunters but account for false positives

```{r}
effort <- matrix(unlist(wolves[,47:51]), nrow(wolves), 5)
```


```{r}
oc <- list(effort = effort)
```


```{r}
umfFP <- unmarkedFrameOccuFP(y = wolves[,20:24],
                             obsCovs = oc, 
                             type = c(0,5,0))
```


Summarize data frame
```{r}
str(umfFP)                     
```

Fit model
```{r}
fm2 <- occuFP(detformula = ~effort, 
              FPformula = ~effort, 
              Bformula = ~1, 
              stateformula = ~1, 
              starts = c(0, 0, 0, -5, 0),
              data = umfFP)
```

Estimates?
```{r}
coef(fm2)
```

Get occupancy prob estimate:
```{r}
backTransform(fm2, 'state')
```


## Add in the agency data

```{r}
effort <- matrix(unlist(wolves[,c(52,47:51)]), nrow(wolves), 6)
```

```{r}
oc <- list(effort = effort)
```


```{r}
y <- wolves[,c(25,20:24)]
y[,1] <- y[,1] / 2
```


```{r}
umfFP <- unmarkedFrameOccuFP(y = y,
                             obsCovs = oc, 
                             type = c(1,5,0))
```

Summarize data frame
```{r}
str(umfFP)                     
```

Fit model
```{r}
fm3 <- occuFP(detformula = ~effort, 
              FPformula = ~effort, 
              Bformula = ~1, 
              stateformula = ~1, 
              starts = c(0, 0, 0, -5, 0),
              data = umfFP) 
```

Print results
```{r}
fm3
```

## Account for habitat quality

```{r}
effort <- matrix(unlist(wolves[,c(52,47:51)]), nrow(wolves), 6)
```


```{r}
oc <- list(effort = effort)
```


```{r}
y <- wolves[,c(25,20:24)]
y[,1] <- y[,1] / 2
```


```{r}
umfFP <- unmarkedFrameOccuFP(y = y,
                             siteCovs = wolves[,26:28],
                             obsCovs = oc, 
                             type = c(1,5,0))
```

Summarize data frame
```{r}
str(umfFP)                     
```

Fit model
```{r}
fm4 <- occuFP(detformula = ~effort, 
              FPformula = ~effort, 
              Bformula = ~1, 
              stateformula = ~High + Medium + Low - 1, 
              starts = c(0, 0, 0, 0, 0, -5, 0),
              data = umfFP)
```

Occupancy estimates
```{r}
lc <- linearComb(fm4, c(1, 0, 0), type="state") # occ on the logit scale when high
psi_high <- backTransform(lc)
```

```{r}
lc <- linearComb(fm4, c(0, 1, 0), type="state") # occ on the logit scale when medium
psi_medium <- backTransform(lc)
```

```{r}
lc <- linearComb(fm4, c(0, 0, 1), type="state") # occ on the logit scale when low
psi_low <- backTransform(lc)
```

Compare the following estimates with Figure 4, upper left panel.
```{r}
psi_high@estimate
psi_medium@estimate
psi_low@estimate
```

Get detection estimates as a function of effort

```{r}
effort_grid <- seq(min(oc$effort), max(oc$effort), length = 100)
```

```{r}
p11 <- plogis(coef(fm4)[4] + coef(fm4)[5] * effort_grid)
p01 <- plogis(coef(fm4)[6] + coef(fm4)[7] * effort_grid)
```

Compare figure below with Figure 3.
```{r}
plot(effort_grid, 
     p11, 
     type = "l", 
     lwd = 3, 
     xlab = "effort", 
     ylab = "detection probability",
     col = "red",
     ylim = c(0,1))
lines(effort_grid, 
     p01,
     lwd = 3, 
     col = "blue")
legend("bottomright", legend = c("true positive det prob (p11)",
                                 "false positive det prob (p01)"),
                                 col = c("red", "blue"), 
       lwd = 3)
```

Both the true positive (p11) and false positive (p01) detection probabilities as hunter effort increased (Figure 3). False positive probabilities were greater than 0.5 in areas with the greatest hunting effort. 

